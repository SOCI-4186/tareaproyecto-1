# =============================================================================
# GitHub Classroom: Verificaci√≥n de Entrega - Tarea de Proyecto 1
# SOCI 4186 - M√©todos Computacionales en Sociolog√≠a
# Universidad de Puerto Rico, Recinto de R√≠o Piedras
# =============================================================================
#
# IMPORTANTE: Este workflow NO asigna calificaciones.
# Solo verifica que la tarea cumpla los requisitos m√≠nimos para renderizarse.
#
# ‚úÖ Palomita verde = Tu documento se puede procesar correctamente
# ‚ùå X roja = Hay un problema t√©cnico que debes corregir
#
# La evaluaci√≥n del contenido acad√©mico la realiza el profesor.
#
# =============================================================================

name: GitHub Classroom Workflow

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Permite ejecuci√≥n manual

# Permisos m√≠nimos necesarios
permissions:
  checks: write
  contents: read

jobs:
  # =========================================================================
  # VERIFICACI√ìN DE ENTREGA (NO ES CALIFICACI√ìN)
  # =========================================================================
  verificar-entrega:
    name: Verificar requisitos de entrega
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # --- Preparaci√≥n del entorno ---
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # --- VERIFICACI√ìN 1: Archivos requeridos ---
      - name: "üìÅ Verificar archivos requeridos"
        id: archivos
        run: |
          echo "::group::Verificando estructura de archivos"

          errores=0

          # Archivo principal (OBLIGATORIO)
          if [ -f "tarea_proyecto_01.qmd" ]; then
            echo "‚úì tarea_proyecto_01.qmd encontrado"
          else
            echo "::error file=tarea_proyecto_01.qmd::Falta el archivo principal de la tarea"
            errores=$((errores + 1))
          fi

          # Archivo de referencias (OBLIGATORIO - aunque est√© vac√≠o)
          if [ -f "Referencias.bib" ]; then
            echo "‚úì Referencias.bib encontrado"
          else
            echo "::error file=Referencias.bib::Falta el archivo de referencias bibliogr√°ficas"
            errores=$((errores + 1))
          fi

          # Archivos de estilo (OBLIGATORIOS - no deben borrarse)
          for archivo in "apa-clacso.csl" "uprrp-theme.css"; do
            if [ -f "$archivo" ]; then
              echo "‚úì $archivo encontrado"
            else
              echo "::error file=$archivo::Falta archivo de configuraci√≥n. No borres los archivos originales."
              errores=$((errores + 1))
            fi
          done

          echo "::endgroup::"

          if [ $errores -gt 0 ]; then
            echo "resultado=fallo" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "resultado=ok" >> $GITHUB_OUTPUT

      # --- VERIFICACI√ìN 2: Plantilla editada ---
      - name: "‚úèÔ∏è Verificar que la plantilla fue editada"
        id: editado
        run: |
          echo "::group::Verificando edici√≥n de plantilla"

          # Verificar que el estudiante cambi√≥ su nombre
          if grep -q "Pon tu nombre aqu√≠" tarea_proyecto_01.qmd; then
            echo "::error file=tarea_proyecto_01.qmd,line=4::No has cambiado tu nombre. Edita la l√≠nea 'author:' en el encabezado YAML."
            echo "resultado=fallo" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          fi

          echo "‚úì El campo 'author' fue modificado"
          echo "::endgroup::"
          echo "resultado=ok" >> $GITHUB_OUTPUT

      # --- VERIFICACI√ìN 3: Renderizado ---
      - name: Instalar Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: "1.4.557"

      - name: Instalar R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3.0"
          use-public-rspm: true

      - name: Instalar paquetes R
        run: |
          install.packages(c("knitr", "rmarkdown", "yaml"), repos = "https://cloud.r-project.org")
        shell: Rscript {0}

      - name: "üî® Verificar que el documento renderiza"
        id: render
        run: |
          echo "::group::Renderizando documento"

          # Intentar renderizar solo HTML (m√°s r√°pido, no requiere LaTeX)
          if quarto render tarea_proyecto_01.qmd --to html 2>&1; then
            echo "‚úì Documento renderizado exitosamente"
            echo "resultado=ok" >> $GITHUB_OUTPUT
          else
            echo "::error file=tarea_proyecto_01.qmd::El documento no se pudo renderizar. Revisa los errores de sintaxis."
            echo "resultado=fallo" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 1
          fi

          echo "::endgroup::"

      # --- AVISOS (no bloquean) ---
      - name: "üìã Verificaciones informativas"
        if: success()
        run: |
          echo "::group::Verificaciones adicionales (informativas)"

          # Aviso sobre declaraci√≥n de MEL
          if grep -q "\[Su declaraci√≥n aqu√≠\.\.\.\]" tarea_proyecto_01.qmd; then
            echo "::warning file=tarea_proyecto_01.qmd::Recuerda completar la declaraci√≥n de uso de MEL/LLM"
          fi

          # Informaci√≥n sobre citas
          citas=$(grep -oE '@[a-zA-Z0-9_:-]+' tarea_proyecto_01.qmd 2>/dev/null | grep -v '@fig-' | grep -v '@tbl-' | sort -u | wc -l || echo "0")
          if [ "$citas" -eq "0" ]; then
            echo "::notice::No se detectaron citas bibliogr√°ficas. Las citas son recomendadas pero no obligatorias para TP1."
          else
            echo "Se detectaron aproximadamente $citas cita(s) en el documento."
          fi

          echo "::endgroup::"

      # --- RESUMEN FINAL ---
      - name: "üìä Resumen de verificaci√≥n"
        if: always()
        run: |
          echo ""
          echo "==========================================================="
          echo "  VERIFICACI√ìN DE ENTREGA - TAREA DE PROYECTO 1"
          echo "==========================================================="
          echo ""
          echo "  IMPORTANTE: Esta verificaci√≥n NO es una calificaci√≥n."
          echo "  Solo confirma que tu documento cumple los requisitos"
          echo "  t√©cnicos m√≠nimos para ser procesado."
          echo ""
          echo "  ‚úÖ Verde = Listo para revisi√≥n del profesor"
          echo "  ‚ùå Rojo  = Corrige los errores indicados arriba"
          echo ""
          echo "  La evaluaci√≥n del contenido acad√©mico (tema, pregunta,"
          echo "  justificaci√≥n, etc.) la realiza el profesor."
          echo ""
          echo "==========================================================="
